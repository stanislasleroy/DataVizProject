<html>
  <head>
    <meta charset="utf-8">
    <link
          rel="stylesheet"
          href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css"
      />
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script
          src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js">
      </script>
    <style>
      body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }

      #map {
        width: 100%;
        height: 100%;
      }
      .hidden {
          display: none;
      }
      div.tooltip {
          color: #222;
          background-color: #fff;
          padding: .5em;
          text-shadow: #f5f5f5 0 1px 0;
          border-radius: 2px;
          opacity: 0.9;
          position: absolute;
      }

    </style>
  </head>

  <body>
    <div>
      <input id="slider" type="range" value="1" min="1" max="100" step="1" />
      <span id="week">heure</span>
    </div>
      <div id="map">

      <!--<div id="map" style="width: 600px; height: 400px"></div>-->

      <script>

          //var map = L.map('map').setView([-41.2858, 174.7868], 13);
/*
          mapLink =
              '<a href="http://openstreetmap.org">OpenStreetMap</a>';
          L.tileLayer(
              'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; ' + mapLink + ' Contributors',
              maxZoom: 18,
              }).addTo(map);
              */

              //var map = new L.Map("map", {center: [45.750000, 4.850000], zoom: 13})
                // .addLayer(new L.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"));

                var map = L.map('map').setView([45.750000, 4.850000], 13);

                L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
                  attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
                  maxZoom: 18,
                  id: 'stanislasleroy.293gad2b',
                  accessToken: 'pk.eyJ1Ijoic3RhbmlzbGFzbGVyb3kiLCJhIjoiY2l3N29ieTFhMDAwbzJ6bzYydmM0cjM4cyJ9.a9t7av6dljaj5TN_FA4XvQ'
                }).addTo(map);



              var svg = d3.select(map.getPanes().overlayPane).append("svg"),
                  g = svg.append("g").attr("class", "leaflet-zoom-hide");


                  var tooltip = d3.select('body').append('div')
                  	.attr('class', 'hidden tooltip');







              // Affichage des stations Vélo'v

              d3.json("stations.json", function(error, collection2) {
                if (error) throw error;

              var transform2 = d3.geo.transform({point: projectPoint2}),
                    path2 = d3.geo.path().projection(transform2).pointRadius(4);

                 var feature2 = g.selectAll("path")
                     .data(collection2.features)
                     .enter().append("path")
                     .style({'stroke' : 'black', 'stroke-width': 2, 'stroke-linejoin': 'square'})
                     .style("fill", function(d) {

                       //console.log(d.properties.stationbonus);

                         var returnColor;

                         if (d.properties.stationbonus === "Oui") {
                           returnColor = "#FFBF00";
                       } else {
                         returnColor = "#d3d3d3";
                       }
                        return returnColor;
                     })
                     /*.style("stroke-width", function(d) {

                       console.log(d.properties.nbbornettes);

                         var size;

                         if (d.properties.nbbornettes < 15) {
                           size = 2;
                       } else if(d.properties.nbbornettes < 20 && d.properties.nbbornettes > 15) {
                         size = 4;
                       } else {
                         size = 6;
                       }
                        return size;
                     })*/
                     .on('mousemove', function(d) {

                       var mouse = d3.mouse(svg.node()).map(function(d) {
                         return parseInt(d);
                       });

                         //console.log(d);

                          tooltip.classed('hidden', false)
                           .attr('style', 'left:' + (mouse[0]) +
                                 'px; top:' + (mouse[1]) + 'px')
                           .html(d.properties.nom + "<br>Id station : " + d.properties.idstation + "<br>Nb de bornes : " + d.properties.nbbornettes + "<br>Station bonus : " + d.properties.stationbonus);

                           //d3.select(this).style("width", "10");
                           //d3.select(this).style("fill", "pink");
                           d3.select(this).style("stroke", "red");
                           d3.select(this).style("stroke-width", "15");
                           //d3.select(this).style("pointRadius", "10");
                     })
                     .on('mouseout', function() {
                       tooltip.classed('hidden', true);
                      // On remet l'opacité à 1
                      d3.select(this).style("stroke", "black");
                      d3.select(this).style("stroke-width", "2");

                     });


                map.on("viewreset", reset2);
                console.log("reset1");
                reset2();

                // Reposition the SVG to cover the features.
                function reset2() {
                  var bounds2 = path2.bounds(collection2),
                      topLeft2 = bounds2[0],
                      bottomRight2 = bounds2[1];

                  svg .attr("width", bottomRight2[0] - topLeft2[0])
                      .attr("height", bottomRight2[1] - topLeft2[1])
                      .style("left", topLeft2[0] + "px")
                      .style("top", topLeft2[1] + "px");

                  g.attr("transform", "translate(" + -topLeft2[0] + "," + -topLeft2[1] + ")");

                  feature2.attr("d", path2);
                }

                // Use Leaflet to implement a D3 geometric transformation.
                function projectPoint2(x, y) {
                  var point = map.latLngToLayerPoint(new L.LatLng(y, x));
                  this.stream.point(point.x, point.y);2
                }
              });







              // Affichage des stations de métro
              d3.json("ligne_metro.json", function(error, collection) {
                if (error) throw error;

              var transform = d3.geo.transform({point: projectPoint}),
                    path = d3.geo.path().projection(transform);

                 var feature = g.selectAll("path")
                     .data(collection.features)
                     .enter().append("path")
                    .style({'fill': '#B10000', 'fill-opacity': 0.0})
                    .style({'stroke-width': 3, 'stroke': 'red', 'stroke-linejoin': 'round', 'stroke-linecap' : 'round'})
                    .style("stroke", function(d) {

                      var array = d.properties.couleur.split(" ");

                      var color = (d3.rgb(array[0], array[1], array[2])).toString();
                      return color ;
                    });

                map.on("viewreset", reset);
                console.log("reset2");
                reset();

                // Reposition the SVG to cover the features.
                function reset() {

                  console.log("Reset metro");

                  var bounds = path.bounds(collection),
                      topLeft = bounds[0],
                      bottomRight = bounds[1];

                  svg .attr("width", bottomRight[0] - topLeft[0])
                      .attr("height", bottomRight[1] - topLeft[1])
                      .style("left", topLeft[0] + "px")
                      .style("top", topLeft[1] + "px");

                  g.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");

                  feature.attr("d", path);
                }

                // Use Leaflet to implement a D3 geometric transformation.
                function projectPoint(x, y) {
                  var point = map.latLngToLayerPoint(new L.LatLng(y, x));
                  this.stream.point(point.x, point.y);
                }
              });


      </script>
  </body>
</html>
