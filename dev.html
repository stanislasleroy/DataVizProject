<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="leaflet.css" />
    <script src="d3.v3.min.js"></script>
    <script src="d3-queue.v3.min.js"></script>
    <script src="leaflet.js">
    </script>
    <script src="functions.js" type="text/javascript"></script>
    <style>
        body {
            margin: 0;
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .hidden {
            display: none;
        }
        
        div.tooltip {
            color: #222;
            background-color: #fff;
            padding: .5em;
            text-shadow: #f5f5f5 0 1px 0;
            border-radius: 2px;
            opacity: 0.9;
            position: absolute;
        }
        
        .hiddenLine {
            display: none;
        }
        
        .ring {
            fill: none;
            stroke: #c7141a;
        }
    </style>
</head>

<body>
    <div>
        <input id="slider" type="range" value="1" min="1" max="100" step="1" />
        <span id="day">jour</span>
    </div>
    <div id="map">

        <!--<div id="map" style="width: 600px; height: 400px"></div>-->

        <script>
            //var map = L.map('map').setView([-41.2858, 174.7868], 13);
            /*
                      mapLink =
                          '<a href="http://openstreetmap.org">OpenStreetMap</a>';
                      L.tileLayer(
                          'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                          attribution: '&copy; ' + mapLink + ' Contributors',
                          maxZoom: 18,
                          }).addTo(map);
                          */
            //var map = new L.Map("map", {center: [45.750000, 4.850000], zoom: 13})
            // .addLayer(new L.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"));

            var initial_zoom = 14;
            var current_zoom;

            // Temps de trajet théorique des différents lignes (ms)
            var durationA = 1260000; // 21 minutes
            var durationB = 1020000; // 17 minutes
            var durationC = 540000; // 9 minutes
            var durationD = 1500000; // 25 minutes
            var duration = 10000;

            // var divider  = 1000;
            var divider = 100;

            // Distance pour prendre en compte les stations Vélov voisine
            // des stations de métro
            var distanceToStation = 200;

            var details_line = {};
            var selectedLine = "";

            var stop_points = {};
            stop_points['type'] = 'FeatureCollection';
            stop_points['features'] = [];

            var total_bike_stations = {};
            var nearby_bike_stations = {};
            var bike_stations_history = {};

            var stop_times = {};
            var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

            var current_day = "2016-12-23";
            // var current_day;
            var available_days = [];

            // var map = L.map('map').setView([45.750000, 4.850000], initial_zoom);
            var map = L.map('map').setView([45.766000, 4.865000], initial_zoom);

            // var map = new L.Map("map", {
            //         center: [45.750000, 4.850000],
            //         zoom: initial_zoom
            //     })
            //     .addLayer(new L.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"));

            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
                maxZoom: 18,
                id: 'stanislasleroy.293gad2b',
                accessToken: 'pk.eyJ1Ijoic3RhbmlzbGFzbGVyb3kiLCJhIjoiY2l3N29ieTFhMDAwbzJ6bzYydmM0cjM4cyJ9.a9t7av6dljaj5TN_FA4XvQ'
            }).addTo(map);

            // Affichage des lignes de métro cachées
            map.on('click', function(d) {
                var e = d.originalEvent.path[0];

                if (!d3.select(e).attr("class")) {
                    selectedLine = "";
                    d3.selectAll('.train').each(function(d, i) {
                        d3.select(this).classed("hiddenLine", false);
                    });

                    d3.selectAll('.pie').each(function(d, i) {
                        d3.select(this).classed("hiddenLine", false);
                    });
                }
            })

            map.on('zoomend', function() {
                console.log(map.getZoom());
            });


            var transform = d3.geo.transform({
                point: projectPoint
            });


            // var path = d3.geo.path().projection(transform);

            var svg = d3.select(map.getPanes().overlayPane)
                .append("svg");
            // .attr("width", '100%')
            // .attr("height", '100%')

            var g = svg.append("g").attr("class", "leaflet-zoom-hide");

            var tooltip = d3.select('body').append('div')
                .attr('class', 'hidden tooltip');

            d3.select("#slider").on("input", function() {
                //    console.log(+this.value);
                d3.select('#day').html(available_days[+this.value - 1]);
                //    current_day = available_days[+this.value - 1];
            });


            // map.on("viewreset")();
            // map.fireEvent('viewreset');



            d3.queue()
                .defer(d3.json, "point_arret.json")
                .defer(d3.json, "ligne_metro.json")
                .defer(d3.json, "stations.json")
                .defer(d3.json, "neptune/301.json")
                .defer(d3.json, "neptune/302.json")
                .defer(d3.json, "neptune/303.json")
                .defer(d3.json, "neptune/304.json")
                .defer(d3.json, "neptune/325.json")
                .defer(d3.json, "neptune/326.json")
                // .defer(d3.json, "horaires/2012-12-23.json")
                .defer(d3.json, "GetVelovHistory/history2.json")
                .defer(d3.json, "tram.json")
                .defer(d3.json, "bus.json")
                .awaitAll(displayPrimaryLine);


            /*
             * Affichage des lignes de métro et des stations
             */
            function displayPrimaryLine(error, files) {

                ///////////////
                // Partie fixe
                ///////////////

                // Affichage des lignes de tram et de bus
                displaySecondaryLine(files[10], "pathTram");
                displaySecondaryLine(files[11], "pathBus");

                // Affichage des lignes de Métro
                displayLineStations(files[1]);

                // Affichage des stations Vélo'v
                displayBikeStations(files[2]);

                total_bike_stations = files[2];
                loadBikeStationsHistory(files[9]);


                // On ajoute les codes Titan des lignes de métro pour pouvoir récupérer les points d'arrêts des lignes
                // for (var i in lines.features) {
                for (var i in files[1].features) {
                    // var id = lines.features[i].properties.code_titan;
                    var id = files[11].features[i].properties.code_titan;
                    id = id.substring(0, 3);
                    details_line[id] = {};
                    details_line[id].id = id;
                    details_line[id].color = files[1].features[i].properties.couleur;
                }



                // On ajoute les codes Titan des lignes de métro pour pouvoir récupérer les points d'arrêts des lignes
                // for (var i in stationsMetro.features) {
                for (var i in files[0].features) {

                    // var id = stationsMetro.features[i].properties.desserte.substring(0, 3);
                    var id = files[0].features[i].properties.desserte.substring(0, 3);

                    if (details_line[id]) {

                        if (!details_line[id].stops)
                            details_line[id].stops = [];

                        var stop = {};
                        stop.geo = {};
                        // stop.geo.x = stationsMetro.features[i].geometry.coordinates[0];
                        stop.geo.x = files[0].features[i].geometry.coordinates[0];
                        // stop.geo.y = stationsMetro.features[i].geometry.coordinates[1];
                        stop.geo.y = files[0].features[i].geometry.coordinates[1];
                        details_line[id].stops.push(stop);
                    }
                }

                /*
                 * Affichage des stations Métro
                 */

                var effective_stop_points;

                effective_stop_points = getEffectiveStopPointsForJSON(files[3]);
                loadStopPoints(files[3], effective_stop_points);
                loadStopTimes(files[3], effective_stop_points);

                effective_stop_points = getEffectiveStopPointsForJSON(files[4]);
                loadStopPoints(files[4], effective_stop_points);
                loadStopTimes(files[4]);

                effective_stop_points = getEffectiveStopPointsForJSON(files[5]);
                loadStopPoints(files[5], effective_stop_points);
                loadStopTimes(files[5]);

                effective_stop_points = getEffectiveStopPointsForJSON(files[6]);
                loadStopPoints(files[6], effective_stop_points);
                loadStopTimes(files[6]);

                effective_stop_points = getEffectiveStopPointsForJSON(files[7]);
                loadStopPoints(files[7], effective_stop_points);
                loadStopTimes(files[7]);

                effective_stop_points = getEffectiveStopPointsForJSON(files[8]);
                loadStopPoints(files[8], effective_stop_points);
                loadStopTimes(files[8]);


                getNearbyBikeStations();

                // Affichage des stations de métro
                displayMetroStations(stop_points);



                // Affichage des donut

                var data1 = [{
                    "type": "available_bikes",
                    "number": 0
                }, {
                    "type": "available_bike_stands",
                    "number": 20
                }];


                // Zoom
                var zoom = d3.behavior.zoom()
                    .on("zoom", function() {

                        console.log("Zoom");
                        // g.attr("transform", "translate(" +
                        //     d3.event.translate.join(",") + ")scale(" + d3.event.scale + ")");
                        // g.selectAll("circle")
                        //     .attr("d", path.projection(projection))
                        //     .attr("r", 5 / zoom.scale());
                        // g.selectAll("path")
                        //     .attr("d", path.projection(projection));
                    });

                map.on('zoomend', function() {
                    console.log("Zoom");
                });



                // console.log(nearby_bike_stations);


                for (var line in nearby_bike_stations) {

                    for (var bike_station_id in nearby_bike_stations[line]) {

                        var path5 = d3.geo.path().projection(transform);

                        var bike_station = nearby_bike_stations[line][bike_station_id];
                        var point2 = map.latLngToLayerPoint(new L.LatLng(bike_station.latitude, bike_station.longitude));

                        var width = 800,
                            height = 250,
                            radius = Math.min(width, height) / 2;

                        var color = d3.scale.category10();

                        var arc = d3.svg.arc()
                            .outerRadius(30)
                            .innerRadius(20);

                        var pie = d3.layout.pie()
                            .sort(null)
                            .value(function(d) {
                                return d.number;
                            });

                        // var feat = g.selectAll("piePath")
                        var feat = g.selectAll('.pathPie')
                            .data(pie(data1))
                            .enter()
                            .append("path")
                            .attr("id", "pie-velov-" + bike_station_id)
                            .classed("pie", true)
                            .classed("p" + line, line)
                            .attr("fill", function(d, i) {
                                return color(d.data.type);
                            })
                            .attr("transform", "translate(" + point2.x + "," + point2.y + ")");

                        feat.transition()
                            .duration(500)
                            .attr("fill", function(d, i) {
                                return color(d.data.type);
                            })
                            .attr("d", arc)
                            .each(function(d) {
                                this._current = d;
                            }); // store the initial angles

                        // map.on("viewreset", function() {
                        //     reset(path5, data1, feat);
                        // });

                        // reset(path5, data1, feat);

                        function change(_id, data) {
                            p = d3.selectAll("#pie-velov-" +
                                _id);
                            p.data(pie(data));
                            p.transition().duration(500).attrTween("d", arcTween); // redraw the arcs
                        }


                        // Store the displayed angles in _current.
                        // Then, interpolate from _current to the new angles.
                        // During the transition, _current is updated in-place by d3.interpolate.

                        function arcTween(a) {
                            var i = d3.interpolate(this._current, a);
                            this._current = i(0);
                            return function(t) {
                                return arc(i(t));
                            };
                        }
                    }
                }






                /*
                 * Animation des rames de métro
                 */
                var nodes = d3.selectAll('.lineMetro')[0];

                nodes.forEach(function(data, i) {

                    var nb_stations_rencontrees = 0;

                    var nb_stations = [];

                    var current_line = d3.select(data).attr("code_titan");

                    if (stop_times[current_line]) {

                        var journeys = stop_times[current_line][current_day];

                        var index = 0;

                        var interval = setInterval(function() {

                                if (index >= Object.keys(journeys).length) {
                                    clearInterval(interval);
                                    console.log("Arrêt des métros");
                                } else {

                                    var pathLengthN = data.getTotalLength();
                                    var actived = true;

                                    var circle = g.append("circle")
                                        .attr("r", 8)
                                        .attr("fill", data.style["stroke"])
                                        .attr("transform", getTransform(data))
                                        .attr('fill-opacity', 0.5)
                                        .classed("train", true)
                                        .attr("journey", function() {
                                            return Object.keys(journeys)[index];
                                        })
                                        .classed("hiddenLine", function(d) {
                                            if (selectedLine == "")
                                                return false;
                                            else if (d3.select(data).attr("code_titan") == selectedLine)
                                                return false;
                                            else
                                                return true;
                                        })
                                        .classed("t" + d3.select(data).attr("code_titan"), d3.select(data).attr("code_titan"))
                                        .transition()
                                        .duration(function() {
                                            if (d3.select(data).attr("ligne") == "A")
                                                return durationA / divider;
                                            else if (d3.select(data).attr("ligne") == "B")
                                                return durationB / divider;
                                            else if (d3.select(data).attr("ligne") == "C")
                                                return durationC / divider;
                                            else if (d3.select(data).attr("ligne") == "D")
                                                return durationD / divider;
                                            else
                                                return duration;
                                        })
                                        .ease("linear")
                                        .remove()
                                        .attrTween("transform", function(d, i) {
                                            return function(t) {

                                                var p;

                                                if (d3.select(data).attr("sens") == "Aller")
                                                    p = data.getPointAtLength(pathLengthN * t);
                                                else
                                                    p = data.getPointAtLength(pathLengthN - pathLengthN * t);

                                                var coord = map.layerPointToLatLng(L.point(p.x, p.y));

                                                var code_titan = d3.select(data).attr("code_titan");
                                                var scale = 1;

                                                // for (var key in details_line[code_titan]["stops"]) {
                                                for (var key in stop_points.features) {

                                                    var value = stop_points.features[key];

                                                    // var dist = getDistance(value.geo.y, coord.lat, value.geo.x, coord.lng);
                                                    var dist_to_metro_station = getDistance(value.geometry.coordinates[1], coord.lat, value.geometry.coordinates[0], coord.lng);

                                                    // Si la rame est proche d'une station de métro
                                                    if (dist_to_metro_station < 20) {

                                                        scale = 2 - (dist_to_metro_station / 40);

                                                        // On regarde parmi les stations de Vélo'v voisines
                                                        for (var bike_station_id in nearby_bike_stations[code_titan]) {

                                                            var bike_station = nearby_bike_stations[code_titan][bike_station_id];

                                                            var dist_to_bike_station = getDistance(bike_station.latitude, coord.lat, bike_station.longitude, coord.lng);

                                                            // Si la rame est proche de la station de Vélo'v
                                                            if (dist_to_bike_station < distanceToStation) {

                                                                if (selectedLine == "" || (selectedLine != "" && d3.select(data).attr("code_titan") == selectedLine)) {
                                                                    // if (d3.select(data).attr("code_titan") == "301") {

                                                                    var id = "velov-" + bike_station_id;

                                                                    var h = bike_stations_history["velov-" + bike_station_id];

                                                                    var current_station_id = value.properties.id.substring(value.properties.id.lastIndexOf(":") + 1);

                                                                    if (h) {
                                                                        if (h[current_day]) {

                                                                            var current_station_id = value.properties.id.substring(value.properties.id.lastIndexOf(":") + 1);
                                                                            // console.log(current_station_id);

                                                                            // if (current_station_id == "7606") {

                                                                            var journey_id = Object.keys(journeys)[index];
                                                                            var journey = journeys[journey_id];

                                                                            var passage_time = journey[current_station_id];
                                                                            var passage_date = new Date(current_day + "T" + passage_time);

                                                                            passage_date.setTime(passage_date.getTime() + passage_date.getTimezoneOffset() * 60 * 1000);

                                                                            var coeff = 1000 * 60 * 5;
                                                                            var date = new Date();
                                                                            var rounded = new Date(Math.round(passage_date.getTime() / coeff) * coeff);

                                                                            var date_before;
                                                                            var date_after;

                                                                            if (passage_date < rounded) {
                                                                                date_before = new Date(rounded.getTime() - 5 * 60000);
                                                                                date_after = rounded;
                                                                            } else {
                                                                                date_after = new Date(rounded.getTime() + 5 * 60000);
                                                                                date_before = rounded;
                                                                            }


                                                                            if (h[current_day][date_before.toLocaleTimeString()] && h[current_day][date_after.toLocaleTimeString()]) {

                                                                                var new_data = [{
                                                                                    "type": "available_bikes",
                                                                                    "number": h[current_day][date_after.toLocaleTimeString()].available_bikes
                                                                                }, {
                                                                                    "type": "available_bike_stands",
                                                                                    "number": h[current_day][date_after.toLocaleTimeString()].available_bike_stands
                                                                                }];

                                                                                change(bike_station_id, new_data);


                                                                                var available_bikes_offset = h[current_day][date_after.toLocaleTimeString()].available_bikes - h[current_day][date_before.toLocaleTimeString()].available_bikes;
                                                                                // console.log("Offset : " + available_bikes_offset);
                                                                                // console.log(h[current_day][date_before.toLocaleTimeString()].available_bikes +
                                                                                //     "/" + h[current_day][date_before.toLocaleTimeString()].available_bike_stands +
                                                                                //     " =>" + h[current_day][date_after.toLocaleTimeString()].available_bikes +
                                                                                //     "/" + h[current_day][date_after.toLocaleTimeString()].available_bike_stands +
                                                                                //     " -> Offset : " + available_bikes_offset);


                                                                                // if (available_bikes_offset != 0) {
                                                                                // if (available_bikes_offset < 0 && current_station_id == "velov-6004") {

                                                                                // Si le zoom est au niveau macro/global = 13/14
                                                                                // Cercles concentriques sur les stations de Vélo'v

                                                                                var point = map.latLngToLayerPoint(new L.LatLng(bike_station.latitude, bike_station.longitude));

                                                                                var nb_circles = 0;

                                                                                // var y = setInterval(function() {

                                                                                //     if (nb_circles > Math.abs(available_bikes_offset))
                                                                                //         clearInterval(y);

                                                                                //     // console.log(nb_circles);
                                                                                //     g.append("circle")
                                                                                //         .attr("class", "ring")
                                                                                //         .classed("r" + selectedLine, selectedLine)
                                                                                //         .classed("hiddenLine", function(d) {
                                                                                //             if (selectedLine == "")
                                                                                //                 return false;
                                                                                //             else if (d3.select(data).attr("code_titan") == selectedLine)
                                                                                //                 return false;
                                                                                //             else
                                                                                //                 return true;
                                                                                //         })
                                                                                //         .attr("transform", "translate(" + point.x + ", " + point.y + ")")
                                                                                //         .attr("r", 6)
                                                                                //         .style("stroke-width", 1)
                                                                                //         .style("stroke", "red")
                                                                                //         .transition()
                                                                                //         .ease("linear")
                                                                                //         .duration(1000)
                                                                                //         .style("stroke-opacity", 1e-6)
                                                                                //         .style("stroke-width", 1)
                                                                                //         .style("stroke", "brown")
                                                                                //         .attr("r", 50)
                                                                                //         .remove();

                                                                                //     nb_circles++;
                                                                                // }, 750);


                                                                                // Si le  zoom est au niveau micro/local = 15
                                                                                // Affichage de camemberts
                                                                                // }

                                                                            }
                                                                            // }
                                                                        }
                                                                    }

                                                                    // d3.select("path#id_" + bike_station_id).style("stroke-width", "5")
                                                                    //     .transition()
                                                                    //     // .delay(1000)
                                                                    //     .duration(500)
                                                                    //     .style("stroke-width", "1");
                                                                }
                                                            }
                                                        }
                                                    }
                                                }

                                                return "translate(" + [p.x, p.y] + ")scale(" + scale + ")";
                                            }
                                        });

                                    index++;
                                }
                            },
                            2000);
                    }
                });
            }
        </script>
</body>

</html>