<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="leaflet.css" />
    <script src="d3.v3.min.js"></script>
    <script src="d3-queue.v3.min.js"></script>
    <script src="leaflet.js">
    </script>
    <script src="functions.js" type="text/javascript"></script>
    <style>
        body {
            margin: 0;
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .hidden {
            display: none;
        }
        
        div.tooltip {
            color: #222;
            background-color: #fff;
            padding: .5em;
            text-shadow: #f5f5f5 0 1px 0;
            border-radius: 2px;
            opacity: 0.9;
            position: absolute;
        }
        
        .hiddenLine {
            display: none;
        }
        
        .dot {
            fill: #c7141a;
        }
        
        .ring {
            fill: none;
            stroke: #c7141a;
        }
    </style>
</head>

<body>
    <div>
        <input id="slider" type="range" value="1" min="1" max="100" step="1" />
        <span id="week">heure</span>
    </div>
    <div id="map">

        <!--<div id="map" style="width: 600px; height: 400px"></div>-->

        <script>
            //var map = L.map('map').setView([-41.2858, 174.7868], 13);
            /*
                      mapLink =
                          '<a href="http://openstreetmap.org">OpenStreetMap</a>';
                      L.tileLayer(
                          'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                          attribution: '&copy; ' + mapLink + ' Contributors',
                          maxZoom: 18,
                          }).addTo(map);
                          */
            //var map = new L.Map("map", {center: [45.750000, 4.850000], zoom: 13})
            // .addLayer(new L.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"));

            var initial_zoom = 15;
            var current_zoom;

            // Temps de trajet théorique des différents lignes (ms)
            var durationA = 1260000; // 21 minutes
            var durationB = 1020000; // 17 minutes
            var durationC = 540000; // 9 minutes
            var durationD = 1500000; // 25 minutes
            var duration = 10000;

            // var divider  = 1000;
            var divider = 100;

            // Distance pour prendre en compte les stations Vélov voisine
            // des stations de métro
            var distanceToStation = 200;

            var details_line = {};
            var selectedLine = "";

            var stop_points = {};
            stop_points['type'] = 'FeatureCollection';
            stop_points['features'] = [];

            var total_bike_stations = {};
            var nearby_bike_stations = {};

            var bike_stations_history = {};
            var bike_stations_current_data = {};

            var stop_times = {};
            var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

            // var current_day = "2016-11-21";
            var current_day = "2016-12-23";

            // var map = L.map('map').setView([45.750000, 4.850000], initial_zoom);
            var map = L.map('map').setView([45.766000, 4.865000], initial_zoom);

            // var map = new L.Map("map", {
            //         center: [45.750000, 4.850000],
            //         zoom: initial_zoom
            //     })
            //     .addLayer(new L.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"));

            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
                maxZoom: 18,
                id: 'stanislasleroy.293gad2b',
                accessToken: 'pk.eyJ1Ijoic3RhbmlzbGFzbGVyb3kiLCJhIjoiY2l3N29ieTFhMDAwbzJ6bzYydmM0cjM4cyJ9.a9t7av6dljaj5TN_FA4XvQ'
            }).addTo(map);

            // Affichage des lignes de métro cachées
            map.on('click', function(d) {
                var e = d.originalEvent.path[0];

                if (!d3.select(e).attr("class")) {
                    selectedLine = "";
                    d3.selectAll('.train').each(function(d, i) {
                        d3.select(this).classed("hiddenLine", false);
                    });
                }
            })

            map.on('zoomend', function() {
                console.log(map.getZoom());
            });


            var transform = d3.geo.transform({
                point: projectPoint
            });


            // var path = d3.geo.path().projection(transform);

            var svg = d3.select(map.getPanes().overlayPane).append("svg");
            var g = svg.append("g").attr("class", "leaflet-zoom-hide");

            var tooltip = d3.select('body').append('div')
                .attr('class', 'hidden tooltip');


            d3.queue()
                .defer(d3.json, "tram.json")
                .await(displaySecondaryLine);

            d3.queue()
                .defer(d3.json, "bus.json")
                .await(displaySecondaryLine);

            d3.queue()
                .defer(d3.json, "point_arret.json")
                .defer(d3.json, "ligne_metro.json")
                .defer(d3.json, "stations.json")
                .defer(d3.json, "neptune/301.json")
                .defer(d3.json, "neptune/302.json")
                .defer(d3.json, "neptune/303.json")
                .defer(d3.json, "neptune/304.json")
                .defer(d3.json, "neptune/325.json")
                .defer(d3.json, "neptune/326.json")
                .defer(d3.json, "horaires/2012-12-23.json")
                .await(displayPrimaryLine);


            /*
             * Création des lignes secondaires : tram et bus
             */
            function displaySecondaryLine(error, lines) {

                // var transform = d3.geo.transform({
                //     point: projectPoint
                // });
                var path = d3.geo.path().projection(transform);

                var feature = g.selectAll("pathTram")
                    .data(lines.features)
                    .enter().append("path")
                    .style({
                        'fill': '#B10000',
                        'fill-opacity': 0.0
                    })
                    .style({
                        'stroke-width': 1,
                        'stroke': 'red',
                        'stroke-linejoin': 'round',
                        'stroke-linecap': 'round'
                    })
                    .style("stroke", function(d) {
                        var array = d.properties.couleur.split(" ");
                        var color = (d3.rgb(array[0], array[1], array[2])).toString();
                        return color;
                    });

                map.on("viewreset", function() {
                    reset(path, lines, feature);
                });

                reset(path, lines, feature);
            }


            // var dataset = {
            //     apples: [53245, 28479, 19697, 24037, 40245],
            // };

            // var width = 460,
            //     height = 300,
            //     radius = Math.min(width, height) / 2;

            // var color = d3.scale.category20();

            // var pie = d3.layout.pie()
            //     .sort(null);

            // var arc = d3.svg.arc()
            //     .innerRadius(radius - 100)
            //     .outerRadius(radius - 50);

            // // var svg = d3.select("body").append("svg")
            // //     .attr("width", width)
            // //     .attr("height", height)
            // //     .append("g")
            // //     .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

            // var path = g.selectAll("path")
            //     .data(pie(dataset.apples))
            //     .enter().append("path")
            //     .attr("transform", "translate(" + 300 + "," + 400 + ")")
            //     .attr("fill", function(d, i) {
            //         return color(i);
            //     })
            //     .attr("d", arc);


            /*
             * Affichage des lignes de métro et des stations
             */
            function displayPrimaryLine(error, stationsMetro, lines, stationsVelo, stopTimes301, stopTimes302, stopTimes303, stopTimes304, stopTimes325, stopTimes326, horaires) {



                // var dataset = {
                //     apples: [53245, 28479, 19697, 24037, 40245],
                // };

                // var width = 460,
                //     height = 300,
                //     radius = Math.min(width, height) / 2;

                // var color = d3.scale.category20();

                // var pie = d3.layout.pie()
                //     .sort(null);

                // var arc = d3.svg.arc()
                //     .innerRadius(radius - 100)
                //     .outerRadius(radius - 50);

                // // var svg = d3.select("body").append("svg")
                // //     .attr("width", width)
                // //     .attr("height", height)
                // //     .append("g")
                // //     .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

                // var path = g.selectAll("path")
                //     .data(pie(dataset.apples))
                //     .enter().append("path")
                //     .attr("fill", function(d, i) {
                //         return color(i);
                //     })
                //     .attr("d", arc);



                var path1 = d3.geo.path().projection(transform);
                var path2 = d3.geo.path().projection(transform);
                var path3 = d3.geo.path().projection(transform);

                total_bike_stations = stationsVelo;


                loadBikeStationsHistory(horaires);

                /*
                 * Affichage des stations Vélo'v
                 */
                var feature1 = g.selectAll("pathVelov")
                    .data(stationsVelo.features)
                    .enter().append("path")
                    .classed("stationsVelo", true)
                    .attr("id", function(d) {
                        return "id_" + d.properties.idstation;
                    })
                    .style("stroke", "black")
                    .style("fill", function(d) {
                        return d.properties.stationbonus === "Oui" ? "#FFBF00" : "#d3d3d3";
                    })
                    .on('mouseover', function(d) {
                        var mouse = d3.mouse(svg.node()).map(function(d) {
                            return parseInt(d);
                        });
                        tooltip.classed('hidden', false)
                            .attr('style', 'left:' + (mouse[0]) + 'px; top:' + (mouse[1]) + 'px')
                            // .html(d.properties.nom + "<br>Id station : " + d.properties.idstation + "<br>Nb de bornes : " + d.properties.nbbornettes + "<br>Station bonus : " + d.properties.stationbonus + "<br><br>Coordonnées : " + d.geometry.coordinates[0] + " " + d.geometry.coordinates[1]);
                            .html(d.properties.nom + "<br>Id station : " + d.properties.idstation + "<br>Nb de bornes : " + d.properties.nbbornettes + "<br>Station bonus : " + d.properties.stationbonus);
                        d3.select(this).style("stroke", "red");
                        // d3.select(this).style("stroke-width", "10");
                    })
                    .on('mouseout', function() {
                        tooltip.classed('hidden', true);
                        d3.select(this).style("stroke", "black");
                        // d3.select(this).style("stroke-width", "2");
                    });


                map.on("viewreset", function() {
                    reset(path1, stationsVelo, feature1);
                });

                reset(path1, stationsVelo, feature1);


                // On ajoute les codes Titan des lignes de métro pour pouvoir récupérer les points d'arrêts des lignes
                for (var i in lines.features) {
                    var id = lines.features[i].properties.code_titan;
                    id = id.substring(0, 3);
                    details_line[id] = {};
                    details_line[id].id = id;
                    details_line[id].color = lines.features[i].properties.couleur;
                }



                // On ajoute les codes Titan des lignes de métro pour pouvoir récupérer les points d'arrêts des lignes
                for (var i in stationsMetro.features) {

                    var id = stationsMetro.features[i].properties.desserte.substring(0, 3);

                    if (details_line[id]) {

                        if (!details_line[id].stops)
                            details_line[id].stops = [];

                        var stop = {};
                        stop.geo = {};
                        stop.geo.x = stationsMetro.features[i].geometry.coordinates[0];
                        stop.geo.y = stationsMetro.features[i].geometry.coordinates[1];
                        details_line[id].stops.push(stop);
                    }
                }

                // /*
                //  * Affichage des stations Métro
                //  */
                // // console.log(JSON.stringify(stationsMetro.features[0]));
                // // console.log(stationsMetro.features[0]);
                // // console.log(stationsMetro.features.length);

                var effective_stop_points;

                effective_stop_points = getEffectiveStopPointsForJSON(stopTimes301);
                loadStopPoints(stopTimes301, effective_stop_points);
                loadStopTimes(stopTimes301, effective_stop_points);

                effective_stop_points = getEffectiveStopPointsForJSON(stopTimes302);
                loadStopPoints(stopTimes302, effective_stop_points);
                loadStopTimes(stopTimes302);

                effective_stop_points = getEffectiveStopPointsForJSON(stopTimes303);
                loadStopPoints(stopTimes303, effective_stop_points);
                loadStopTimes(stopTimes303);

                effective_stop_points = getEffectiveStopPointsForJSON(stopTimes304);
                loadStopPoints(stopTimes304, effective_stop_points);
                loadStopTimes(stopTimes304);

                effective_stop_points = getEffectiveStopPointsForJSON(stopTimes325);
                loadStopPoints(stopTimes325, effective_stop_points);
                loadStopTimes(stopTimes325);

                effective_stop_points = getEffectiveStopPointsForJSON(stopTimes326);
                loadStopPoints(stopTimes326, effective_stop_points);
                loadStopTimes(stopTimes326);


                getNearbyBikeStations();
                // console.log(JSON.stringify(nearby_bike_stations));
                // console.log(JSON.stringify(stop_times["301"][current_day]));
                // console.log("stop_times");
                // console.log(stop_times["301"]);
                // console.log(stop_points);


                var feature2 = g.selectAll("pathStationsMetro")
                    // .data(stationsMetro.features)
                    .data(stop_points.features)
                    .enter().append("path")
                    .classed("stationsMetro", true)
                    .attr("id", function(d) {
                        return d.properties.id;
                    })
                    .style({
                        'stroke-width': 4,
                        'stroke-linejoin': 'round',
                        'stroke-linecap': 'round'
                    })
                    .style("stroke", function(d) {
                        return "gray";
                        var id = d.properties.desserte.substring(0, 3);
                        var array = details_line[id].color.split(" ");
                        var color = (d3.rgb(array[0], array[1], array[2])).toString();
                        return color;
                    })
                    .style("fill", function(d) {
                        return "gray";
                        var id = d.properties.desserte.substring(0, 3);
                        var array = details_line[id].color.split(" ");
                        var color = (d3.rgb(array[0], array[1], array[2])).toString();
                        return color;
                    });

                map.on("viewreset", function() {
                    reset(path2, stop_points, feature2);
                });

                reset(path2, stop_points, feature2);


                console.log(JSON.stringify(bike_stations_current_data));


                for (var bike_station_id in nearby_bike_stations["301"]) {

                    // console.log(bike_station_id);

                    // var bike_station = nearby_bike_stations[code_titan][bike_station_id];
                    var bike_station = nearby_bike_stations["301"][bike_station_id];

                    var path4 = d3.geo.path().projection(transform);

                    var object = bike_stations_current_data["velov-" + bike_station_id];

                    if (!object) {

                        // console.log("Creation");

                        bike_stations_current_data["velov-" + bike_station_id] = {
                            "numbers": [{
                                "name": "talk_1",
                                "number": 722,
                            }, {
                                "name": "talk_2",
                                "number": 1000,
                            }]
                        };

                        // bike_stations_current_data["velov-" + bike_station_id] = {
                        //     // bike_stations_current_data = {
                        //     numbers: [
                        //         900, 1000
                        //     ]
                        // };
                    }

                    // console.log(JSON.stringify(bike_stations_current_data));



                    // console.log(bike_stations_current_data);
                    // console.log(bike_stations_current_data["velov-" + bike_station_id].numbers);

                    // bike_stations_current_data["velov-" + bike_station_id] = {
                    // bike_stations_current_data = {
                    //     numbers: [53245, 28479]
                    // };

                    var width = 460,
                        height = 300,
                        radius = Math.min(width, height) / 2;

                    var color = d3.scale.category10();

                    // var pie = d3.layout.pie()
                    //     .sort(null);

                    var pie = d3.layout.pie()
                        .sort(null)
                        .value(function(d) {
                            // console.log("d : " + d);
                            return d.number;
                            // return d;
                        });

                    var arc = d3.svg.arc()
                        .innerRadius(30)
                        .outerRadius(20);

                    var point2 = map.latLngToLayerPoint(new L.LatLng(bike_station.latitude, bike_station.longitude));

                    // var f = g.selectAll("pathPie")
                    // .data(pie(dataset.apples))
                    // if (!bike_stations_current_data["velov-" + bike_station_id]) {

                    //     bike_stations_current_data["velov-" + bike_station_id] = {};

                    //     bike_stations_current_data["velov-" + bike_station_id].push({
                    //         number: 0
                    //     });

                    //     bike_stations_current_data["velov-" + bike_station_id].push({
                    //         number: 0
                    //     });
                    // }

                    // var f = g.datum(dataset.apples).selectAll("pathPie")
                    var f = g.datum(bike_stations_current_data["velov-" + bike_station_id].numbers).selectAll("pathPie")
                        // var f = g.datum(bike_stations_current_data.numbers).selectAll("pathPie")
                        .data(pie)
                        .enter().append("path")
                        .attr("transform", "translate(" + point2.x + "," + point2.y + ")")
                        .attr("fill", function(d, i) {
                            return color(i);
                        })
                        .attr("d", arc);




                    var timeout = setTimeout(function() {
                        change();
                    }, 2000);


                    function change() {

                        var value = this.value;
                        clearTimeout(timeout);
                        pie.value(function(d) {
                            // return d[value];
                            console.log(d.number);
                            // return value;
                            return d.number;
                        }); // change the value function
                        f = f.data(pie); // compute the new angles
                        // f.transition().duration(750).attrTween("d", arcTween); // redraw the arcs
                    }


                    function arcTween(a) {
                        console.log(a);
                        var i = d3.interpolate(this._current, a);
                        this._current = i(0);
                        return function(t) {
                            return arc(i(t));
                        };
                    }

                    // map.on("viewreset", function() {
                    //     reset(path4, dataset.apples, f);
                    // });

                    // reset(path4, dataset.apples, f);

                }


                /*
                 * Affichage des lignes de Métro
                 */
                var feature3 = g.selectAll("pathMetroLine")
                    .data(lines.features)
                    .enter().append("path")
                    .classed("lineMetro", true)
                    .attr("sens", function(d) {
                        return d.properties.sens;
                    })
                    .attr("ligne", function(d) {
                        return d.properties.ligne;
                    })
                    .attr("code_titan", function(d) {
                        return d.properties.code_titan.substring(0, 3);
                    })
                    .style({
                        'fill': 'none'
                    })
                    .style({
                        'stroke-width': 4,
                        'stroke-linejoin': 'round',
                        'stroke-linecap': 'round'
                    })
                    .style("stroke", function(d) {
                        var array = d.properties.couleur.split(" ");
                        var color = (d3.rgb(array[0], array[1], array[2])).toString();
                        return color;
                    })
                    .on('mousemove', function(d) {
                        d3.select(this).style("stroke-width", 8);
                    })
                    .on('click', function(d) {
                        d3.select(this).style("stroke-width", 8);
                        selectedLine = d.properties.code_titan.substring(0, 3);
                        // console.log(selectedLine);
                        //  console.log(d3.selectAll('.train').filter(".t" + selectedLine));

                        d3.selectAll('.train').each(function(d, i) {
                            d3.select(this).classed("hiddenLine", true);
                        });

                        d3.selectAll('.train').filter(".t" + selectedLine).each(function(d, i) {
                            d3.select(this).classed("hiddenLine", false);
                        });
                    })
                    .on('mouseout', function() {
                        d3.select(this).style("stroke-width", 4);
                    });

                map.on("viewreset", function() {
                    reset(path3, lines, feature3);
                });

                reset(path3, lines, feature3);



                /*
                 * Animation des rames de métro
                 */
                var nodes = d3.selectAll('.lineMetro')[0];

                nodes.forEach(function(data, i) {

                    var nb_stations_rencontrees = 0;

                    var nb_stations = [];

                    var current_line = d3.select(data).attr("code_titan");

                    if (stop_times[current_line]) {

                        var journeys = stop_times[current_line][current_day];

                        var index = 0;

                        var interval = setInterval(function() {

                                if (index >= Object.keys(journeys).length) {
                                    clearInterval(interval);
                                    console.log("Arrêt des métros");
                                } else {

                                    var pathLengthN = data.getTotalLength();
                                    var actived = true;

                                    var circle = g.append("circle")
                                        .attr("r", 8)
                                        .attr("fill", data.style["stroke"])
                                        .attr("transform", getTransform(data))
                                        .attr('fill-opacity', 0.5)
                                        .classed("train", true)
                                        .attr("journey", function() {
                                            return Object.keys(journeys)[index];
                                        })
                                        // .classed("hiddenLine", function(d) {
                                        //     if (selectedLine == "")
                                        //         return false;
                                        //     else if (d3.select(data).attr("code_titan") == selectedLine)
                                        //         return false;
                                        //     else
                                        //         return true;
                                        // })
                                        .classed("t" + d3.select(data).attr("code_titan"), d3.select(data).attr("code_titan"))
                                        .transition()
                                        .duration(function() {
                                            if (d3.select(data).attr("ligne") == "A")
                                                return durationA / divider;
                                            else if (d3.select(data).attr("ligne") == "B")
                                                return durationB / divider;
                                            else if (d3.select(data).attr("ligne") == "C")
                                                return durationC / divider;
                                            else if (d3.select(data).attr("ligne") == "D")
                                                return durationD / divider;
                                            else
                                                return duration;
                                        })
                                        .ease("linear")
                                        .remove()
                                        .attrTween("transform", function(d, i) {
                                            return function(t) {

                                                var p;

                                                if (d3.select(data).attr("sens") == "Aller")
                                                    p = data.getPointAtLength(pathLengthN * t);
                                                else
                                                    p = data.getPointAtLength(pathLengthN - pathLengthN * t);

                                                var coord = map.layerPointToLatLng(L.point(p.x, p.y));

                                                var code_titan = d3.select(data).attr("code_titan");
                                                var scale = 1;

                                                // for (var key in details_line[code_titan]["stops"]) {
                                                for (var key in stop_points.features) {

                                                    var value = stop_points.features[key];

                                                    // var dist = getDistance(value.geo.y, coord.lat, value.geo.x, coord.lng);
                                                    var dist_to_metro_station = getDistance(value.geometry.coordinates[1], coord.lat, value.geometry.coordinates[0], coord.lng);

                                                    // Si la rame est proche d'une station de métro
                                                    if (dist_to_metro_station < 20) {

                                                        scale = 2 - (dist_to_metro_station / 40);

                                                        // On regarde parmi les stations de Vélo'v voisines
                                                        for (var bike_station_id in nearby_bike_stations[code_titan]) {

                                                            var bike_station = nearby_bike_stations[code_titan][bike_station_id];

                                                            var dist_to_bike_station = getDistance(bike_station.latitude, coord.lat, bike_station.longitude, coord.lng);

                                                            // Si la rame est proche de la station de Vélo'v
                                                            if (dist_to_bike_station < distanceToStation) {








                                                                // map.on("viewreset", function() {
                                                                //     reset(path4, dataset.apples, f);
                                                                // });

                                                                // reset(path4, dataset.apples, f);









                                                                if (selectedLine == "" || (selectedLine != "" && d3.select(data).attr("code_titan") == selectedLine)) {
                                                                    // if (d3.select(data).attr("code_titan") == "301") {

                                                                    var id = "velov-" + bike_station_id;

                                                                    var h = bike_stations_history["velov-" + bike_station_id];

                                                                    var current_station_id = value.properties.id.substring(value.properties.id.lastIndexOf(":") + 1);

                                                                    bike_stations_current_data["velov-" + bike_station_id] = {
                                                                        "numbers": [{
                                                                            "name": "talk_1",
                                                                            "number": 10,
                                                                        }, {
                                                                            "name": "talk_2",
                                                                            "number": 60,
                                                                        }]
                                                                    };

                                                                    console.log(JSON.stringify(bike_stations_current_data));



                                                                    if (h) {
                                                                        if (h[current_day]) {

                                                                            var current_station_id = value.properties.id.substring(value.properties.id.lastIndexOf(":") + 1);
                                                                            // console.log(current_station_id);

                                                                            // if (current_station_id == "7606") {

                                                                            var journey_id = Object.keys(journeys)[index];
                                                                            var journey = journeys[journey_id];

                                                                            var passage_time = journey[current_station_id];
                                                                            var passage_date = new Date(current_day + "T" + passage_time);

                                                                            passage_date.setTime(passage_date.getTime() + passage_date.getTimezoneOffset() * 60 * 1000);

                                                                            var coeff = 1000 * 60 * 5;
                                                                            var date = new Date();
                                                                            var rounded = new Date(Math.round(passage_date.getTime() / coeff) * coeff);

                                                                            var date_before;
                                                                            var date_after;

                                                                            if (passage_date < rounded) {
                                                                                date_before = new Date(rounded.getTime() - 5 * 60000);
                                                                                date_after = rounded;
                                                                            } else {
                                                                                date_after = new Date(rounded.getTime() + 5 * 60000);
                                                                                date_before = rounded;
                                                                            }




                                                                            if (h[current_day][date_before.toLocaleTimeString()] && h[current_day][date_after.toLocaleTimeString()]) {

                                                                                // if (!bike_stations_current_data[current_station_id])
                                                                                // bike_stations_current_data[current_station_id] = [];

                                                                                // bike_stations_current_data[current_station_id].available_bikes = h[current_day][date_after.toLocaleTimeString()].available_bikes;
                                                                                // bike_stations_current_data[current_station_id].push(h[current_day][date_after.toLocaleTimeString()].available_bikes);
                                                                                // bike_stations_current_data[current_station_id].available_bike_stands = h[current_day][date_after.toLocaleTimeString()].available_bike_stands;
                                                                                // bike_stations_current_data[current_station_id].push(h[current_day][date_after.toLocaleTimeString()].available_bike_stands);
                                                                                // bike_stations_current_data["velov-" + bike_station_id].numbers[0] = h[current_day][date_after.toLocaleTimeString()].available_bikes;

                                                                                // bike_stations_current_data["velov-" + bike_station_id].numbers[1] = h[current_day][date_after.toLocaleTimeString()].available_bike_stands
                                                                                // bike_stations_current_data["velov-" + bike_station_id].numbers[0] = 10;
                                                                                // bike_stations_current_data["velov-" + bike_station_id].numbers[1] = 50;

                                                                                // bike_stations_current_data["velov-" + bike_station_id] = {
                                                                                //     "numbers": [{
                                                                                //         "name": "talk_1",
                                                                                //         "number": 10,
                                                                                //     }, {
                                                                                //         "name": "talk_2",
                                                                                //         "number": 60,
                                                                                //     }]
                                                                                // };


                                                                                var available_bikes_offset = h[current_day][date_after.toLocaleTimeString()].available_bikes - h[current_day][date_before.toLocaleTimeString()].available_bikes;
                                                                                console.log("Offset : " + available_bikes_offset);

                                                                                // if (available_bikes_offset != 0) {
                                                                                if (available_bikes_offset > 0) {

                                                                                    // Si le zoom est au niveau macro/global = 13/14
                                                                                    // Cercles concentriques sur les stations de Vélo'v

                                                                                    var point = map.latLngToLayerPoint(new L.LatLng(bike_station.latitude, bike_station.longitude));

                                                                                    var nb_circles = 0;

                                                                                    var y = setInterval(function() {

                                                                                        if (nb_circles > available_bikes_offset)
                                                                                            clearInterval(y);

                                                                                        // console.log(nb_circles);
                                                                                        g.append("circle")
                                                                                            .attr("class", "ring")
                                                                                            .attr("transform", "translate(" + point.x + ", " + point.y + ")")
                                                                                            .attr("r", 6)
                                                                                            .style("stroke-width", 1)
                                                                                            .style("stroke", "red")
                                                                                            .transition()
                                                                                            .ease("linear")
                                                                                            .duration(6000)
                                                                                            .style("stroke-opacity", 1e-6)
                                                                                            .style("stroke-width", 1)
                                                                                            .style("stroke", "brown")
                                                                                            .attr("r", 50)
                                                                                            .remove();

                                                                                        nb_circles++;
                                                                                    }, 750);






                                                                                    // if (current_zoom == 13 || current_zoom == 14) {


                                                                                    //     console.log("Cercles concentriques");



                                                                                    // } else if (current_zoom == 15) {
                                                                                    //     console.log("Camemberts");
                                                                                    // }


                                                                                    // Si le  zoom est au niveau micro/local = 15
                                                                                    // Affichage de camemberts
                                                                                }

                                                                            }
                                                                            // }
                                                                        }
                                                                    }

                                                                    // d3.select("path#id_" + bike_station_id).style("stroke-width", "5")
                                                                    //     .transition()
                                                                    //     // .delay(1000)
                                                                    //     .duration(500)
                                                                    //     .style("stroke-width", "1");
                                                                }
                                                            }
                                                        }
                                                    }
                                                }

                                                return "translate(" + [p.x, p.y] + ")scale(" + scale + ")";
                                            }
                                        });

                                    index++;
                                }
                            },
                            2000);
                    }
                });
            }
        </script>
</body>

</html>
