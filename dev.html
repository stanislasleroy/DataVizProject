<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="leaflet.css" />
    <script src="d3.v3.min.js"></script>
    <script src="d3-queue.v3.min.js"></script>
    <script src="leaflet.js">
    </script>
<script src="functions.js" type="text/javascript"></script>
<style>
        body {
            margin: 0;
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .hidden {
            display: none;
        }
        
        div.tooltip {
            color: #222;
            background-color: #fff;
            padding: .5em;
            text-shadow: #f5f5f5 0 1px 0;
            border-radius: 2px;
            opacity: 0.9;
            position: absolute;
        }
        
        .hiddenLine {
            display: none;
        }
        
        .ring {
            fill: none;
            stroke: #c7141a;
        }
    </style>
</head>

<body>
    <div>
        <input id="slider" type="range" value="1" min="1" max="100" step="1" />
        <span id="day"></span>
    </div>
    <div id="map">

        <script>
            var initial_zoom = 14;
            var current_zoom;

            var needReset = true;

            // var bounds; //= __path__.bounds(_collection);
            // var topLeft; //= bounds[0];
            // var bottomRight; // = bounds[1];

            // Temps de trajet théorique des différents lignes (ms)
            var durationA = 1260000; // 21 minutes
            var durationB = 1020000; // 17 minutes
            var durationC = 540000; // 9 minutes
            var durationD = 1500000; // 25 minutes
            var duration = 10000;

            // var divider  = 1000;
            var divider = 100;

            // Distance pour prendre en compte les stations Vélov voisine
            // des stations de métro
            var distanceToStation = 200;

            var details_line = {};
            var selectedLine = "";

            var stop_points = {};
            stop_points['type'] = 'FeatureCollection';
            stop_points['features'] = [];

            var total_bike_stations = {};
            var nearby_bike_stations = {};
            var bike_stations_history = {};

            var stop_times = {};
            var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

            var current_day = "2016-12-23";
            // var current_day;
            var available_days = [];

            // var map = L.map('map').setView([45.750000, 4.850000], initial_zoom);
            var map = L.map('map').setView([45.766000, 4.865000], initial_zoom);

            // var map = new L.Map("map", {
            //         center: [45.750000, 4.850000],
            //         zoom: initial_zoom
            //     })
            //     .addLayer(new L.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"));

            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
                maxZoom: 18,
                id: 'stanislasleroy.293gad2b',
                accessToken: 'pk.eyJ1Ijoic3RhbmlzbGFzbGVyb3kiLCJhIjoiY2l3N29ieTFhMDAwbzJ6bzYydmM0cjM4cyJ9.a9t7av6dljaj5TN_FA4XvQ'
            }).addTo(map);

            // Affichage des lignes de métro cachées
            map.on('click', function (d) {
                var e = d.originalEvent.path[0];

                if (!d3.select(e).attr("class")) {

                    selectedLine = "";
                    d3.selectAll('.train').each(function (d, i) {
                        d3.select(this).classed("hiddenLine", false);
                    });

                    if (map.getZoom() >= 15) {
                        d3.selectAll('.pie').each(function (d, i) {
                            d3.select(this).classed("hiddenLine", false);
                        });
                    }
                }
            })

            // map.on('zoomend', function() {
            //     console.log(map.getZoom());
            // });


            var transform = d3.geo.transform({
                point: projectPoint
            });


            var __path__ = d3.geo.path().projection(transform);

            var svg = d3.select(map.getPanes().overlayPane)
                .append("svg");

            var g = svg.append("g").attr("class", "leaflet-zoom-hide");

            var tooltip = d3.select('body').append('div')
                .attr('class', 'hidden tooltip');


            var pie = d3.layout.pie()
                .sort(null)
                .value(function (d) {
                    return d.number;
                });

            var arc = d3.svg.arc()
                .outerRadius(30)
                .innerRadius(20);

            var color = d3.scale.category10();




            d3.select("#slider").on("input", function () {
                //    console.log(+this.value);
                d3.select('#day').html(available_days[+this.value - 1]);
                //    current_day = available_days[+this.value - 1];
            });

            // map.on("viewreset")();
            // map.fireEvent('viewreset');

            d3.queue()
                .defer(d3.json, "point_arret.json")
                .defer(d3.json, "ligne_metro.json")
                .defer(d3.json, "stations.json")
                .defer(d3.json, "neptune/301.json")
                .defer(d3.json, "neptune/302.json")
                .defer(d3.json, "neptune/303.json")
                .defer(d3.json, "neptune/304.json")
                .defer(d3.json, "neptune/325.json")
                .defer(d3.json, "neptune/326.json")
                .defer(d3.json, "GetVelovHistory/history4.json")
                .defer(d3.json, "tram.json")
                .defer(d3.json, "bus.json")
                .awaitAll(displayPrimaryLine);


            /*
             * Affichage des lignes de métro et des stations
             */
            function displayPrimaryLine(error, files) {

                ///////////////
                // Partie fixe
                ///////////////

                // Affichage des lignes de tram et de bus
                console.log("Affichage des lignes secondaires");
                // displaySecondaryLine(files[10], "pathTram");
                // displaySecondaryLine(files[11], "pathBus");

                // Affichage des lignes de Métro
                console.log("Affichage des lignes de Métro");
                displayLineStations(files[1]);

                // Affichage des stations Vélo'v
                console.log("Affichage des stations Vélo'v");
                displayBikeStations(files[2]);

                total_bike_stations = files[2];
                loadBikeStationsHistory(files[9]);


                // On ajoute les codes Titan des lignes de métro pour pouvoir récupérer les points d'arrêts des lignes
                for (var i in files[1].features) {
                    var id = files[11].features[i].properties.code_titan;
                    id = id.substring(0, 3);
                    details_line[id] = {};
                    details_line[id].id = id;
                    details_line[id].color = files[1].features[i].properties.couleur;
                }

                // On ajoute les codes Titan des lignes de métro pour pouvoir récupérer les points d'arrêts des lignes
                for (var i in files[0].features) {

                    var id = files[0].features[i].properties.desserte.substring(0, 3);

                    if (details_line[id]) {

                        if (!details_line[id].stops)
                            details_line[id].stops = [];

                        var stop = {};
                        stop.geo = {};
                        stop.geo.x = files[0].features[i].geometry.coordinates[0];
                        stop.geo.y = files[0].features[i].geometry.coordinates[1];
                        details_line[id].stops.push(stop);
                    }
                }

                var effective_stop_points;

                for (var i = 3; i < 9; i++) {
                    effective_stop_points = getEffectiveStopPointsForJSON(files[i]);
                    loadStopPoints(files[i], effective_stop_points);
                    loadStopTimes(files[i], effective_stop_points);
                }

                // Recherche des stations Vélo'v voisines des stations de métro
                console.log("Recherche des stations Vélo'v voisines");
                getNearbyBikeStations();

                // Affichage des stations de métro
                console.log("ffichage des stations de métro");
                // displayMetroStations(stop_points);


                // Zoom
                var zoom = d3.behavior.zoom()
                    .on("zoom", function () {

                        console.log("Zoom");
                        // g.attr("transform", "translate(" +
                        //     d3.event.translate.join(",") + ")scale(" + d3.event.scale + ")");
                        // g.selectAll("circle")
                        //     .attr("d", path.projection(projection))
                        //     .attr("r", 5 / zoom.scale());
                        // g.selectAll("path")
                        //     .attr("d", path.projection(projection));
                    });

                map.on('zoomend', function () {
                    console.log("Zoom");
                });

                // Affichage des cercles concentriques
                console.log("Affichage des cercles concentriques");
                displayConcentricCircles();

                // Animation des rames de métro
                animateMetro();
            }
        </script>
</body>

</html>